<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Tree ì „ë ¥ ì˜ˆì¸¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <style>
        @font-face {
            font-family: 'NanumSquare';
            src: url('/static/nanum-square/NanumSquareR.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body, .navbar-custom, .logo, .menu a, h1, label, button, .card, .table {
            font-family: 'NanumSquare', Arial, sans-serif !important;
        }
        body { background: #f7f7f2; }
        .navbar-custom {
            background: #0051ba;
            padding: 18px 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
            margin-bottom: 32px;
            box-shadow: none;
        }
        .navbar-custom .logo {
            font-size: 1.7rem;
            font-weight: 900;
            color: #fff;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .navbar-custom .menu a {
            color: #fff;
            text-decoration: none;
            font-weight: 900;
            font-size: 1.2rem;
            margin-left: 32px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .navbar-custom .menu a:hover {
            color: #ffd600;
            text-decoration: underline;
        }
        .container { max-width: 1200px; }
        .card {
            margin-bottom: 20px;
            border-radius: 24px;
            box-shadow: 0 8px 32px #0001;
            border: none;
        }
        .card-title {
            font-weight: 900;
            color: #003580;
            font-size: 1.3rem;
        }
        .btn-primary {
            background: #0051ba;
            border: none;
            border-radius: 18px;
            font-weight: 900;
            font-size: 1.2rem;
            padding: 12px 36px;
            transition: background 0.2s;
        }
        .btn-primary:hover {
            background: #ffd600;
            color: #0051ba;
        }
        .form-label {
            font-weight: 700;
            color: #003580;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 900;
            color: #003580;
            letter-spacing: 2px;
            margin-bottom: 32px;
            text-align: center;
        }
        input[type="text"].date-picker {
            font-size: 1.7rem;
            padding: 22px 28px;
            height: 70px;
            border-radius: 16px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <nav class="navbar-custom">
        <div class="logo">ğŸ”Œ Power Demand Forecasting System</div>
        <div class="menu">
            <a href="/">Home</a>
        </div>
    </nav>
    <div class="container mt-4">
        <h1 class="mb-4">Decision Tree ê¸°ë°˜ ì „ë ¥ ì˜ˆì¸¡</h1>
        
        <!-- ì…ë ¥ í¼ -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">ì˜ˆì¸¡ ë‚ ì§œ ë° ë‚ ì”¨ ì •ë³´ ì…ë ¥</h5>
                <form id="predictionForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="date" class="form-label">ë‚ ì§œ</label>
                                <input type="text" class="form-control date-picker" id="date" name="date" required autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="relative_humidity" class="form-label">ìƒëŒ€ìŠµë„</label>
                                <input type="number" step="0.1" class="form-control" id="relative_humidity" name="relative_humidity">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="vapor_pressure" class="form-label">ìˆ˜ì¦ê¸°ì••</label>
                                <input type="number" step="0.1" class="form-control" id="vapor_pressure" name="vapor_pressure">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="coolingHeating" class="form-label">ëƒ‰ë‚œë°©ì§€ìˆ˜</label>
                                <input type="number" step="0.1" class="form-control" id="coolingHeating" name="coolingHeating">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ms_diff" class="form-label">ìµœëŒ€ì „ë ¥ (ì „ì¼ê³¼ ë¹„êµ)</label>
                                <input type="number" step="0.1" class="form-control" id="ms_diff" name="ms_diff">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="hr_diff" class="form-label">ì‹œê°„ë³„ ì „ë ¥ ë³€í™”</label>
                                <input type="number" step="0.1" class="form-control" id="hr_diff" name="hr_diff">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="CPI_diff" class="form-label">ì†Œë¹„ìë¬¼ê°€ ë³€ë™</label>
                                <input type="number" step="0.1" class="form-control" id="CPI_diff" name="CPI_diff">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="daily_rainfall" class="form-label">ì¼ê°•ìˆ˜ëŸ‰</label>
                                <input type="number" step="0.1" class="form-control" id="daily_rainfall" name="daily_rainfall">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">ì˜ˆì¸¡í•˜ê¸°</button>
                </form>
            </div>
        </div>

        <!-- ë„ë„›í˜• íŒŒì´ì°¨íŠ¸ ë° ì˜µì…˜ ì„¤ëª… ì¹´ë“œ -->
        <div class="doughnut-section" style="max-width: 1200px; margin: 60px auto 40px auto; background: #fff; border-radius: 32px; box-shadow: 0 8px 32px #0051ba22; padding: 48px 36px; text-align: center;">
            <div class="doughnut-title" style="font-size:2.2rem;font-weight:900;color:#222;margin-bottom:36px;">ì„œë¹„ìŠ¤ ì£¼ìš” ê¸°ëŠ¥</div>
            <div class="doughnut-flex" style="display:flex;justify-content:center;align-items:center;gap:32px;height:100%;">
                <div class="doughnut-desc left" style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:64px;height:100%;">
                    <div class="doughnut-option">
                        <div class="doughnut-label" style="color:#1976d2;font-weight:900;font-size:1.1em;letter-spacing:1px;">OPTION 01</div>
                        <div class="doughnut-label">ì‚¬ìš©ì ì…ë ¥ ê¸°ë°˜ ì˜ˆì¸¡<br><span style='font-size:0.95em;font-weight:400;color:#888;'>Input-Based Forecasting</span></div>
                        <div class="doughnut-text">ìµœì‹  ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì…ë ¥ê³¼ ë™ì‹œì— ì „ë ¥ ìˆ˜ìš”ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.<br><span style='color:#888;'>Predict electricity demand based on user input and the latest available data.</span></div>
                    </div>
                    <div class="doughnut-option">
                        <div class="doughnut-label" style="color:#1976d2;font-weight:900;font-size:1.1em;letter-spacing:1px;">OPTION 03</div>
                        <div class="doughnut-label">ê¸°ìƒ ë°ì´í„° ì—°ë™<br><span style='font-size:0.95em;font-weight:400;color:#888;'>Weather Data Integration</span></div>
                        <div class="doughnut-text">ê¸°ì˜¨, ìŠµë„ ë“± ê¸°ìƒ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì˜ˆì¸¡ ì •í™•ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.<br><span style='color:#888;'>Improve forecast accuracy using weather data such as temperature and humidity.</span></div>
                    </div>
                </div>
                <div class="doughnut-center" style="position:relative;width:380px;height:380px;display:flex;align-items:center;justify-content:center;margin:0 auto;">
                    <canvas id="doughnutChartOuter" width="380" height="380" style="position:absolute;left:0;top:0;z-index:1;"></canvas>
                    <canvas id="doughnutChartInner" width="260" height="260" style="position:absolute;left:60px;top:60px;z-index:2;"></canvas>
                </div>
                <div class="doughnut-desc right" style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:64px;height:100%;">
                    <div class="doughnut-option">
                        <div class="doughnut-label" style="color:#1976d2;font-weight:900;font-size:1.1em;letter-spacing:1px;">OPTION 02</div>
                        <div class="doughnut-label">ê³µê¸‰ ê¶Œì¥ëŸ‰ ì œì‹œ<br><span style='font-size:0.95em;font-weight:400;color:#888;'>Recommended Supply Suggestion</span></div>
                        <div class="doughnut-text">ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ 10~15% ì—¬ìœ ë¥¼ ë‘” ê¶Œì¥ ê³µê¸‰ëŸ‰ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.<br><span style='color:#888;'>Based on forecast results, the system suggests recommended supply with a 10â€“15% buffer.</span></div>
                    </div>
                    <div class="doughnut-option">
                        <div class="doughnut-label" style="color:#1976d2;font-weight:900;font-size:1.1em;letter-spacing:1px;">OPTION 04</div>
                        <div class="doughnut-label">ì‹œê°í™” ëŒ€ì‹œë³´ë“œ<br><span style='font-size:0.95em;font-weight:400;color:#888;'>Visual Dashboard</span></div>
                        <div class="doughnut-text">ì˜ˆì¸¡ ê²°ê³¼ì™€ ìµœì‹  ë°ì´í„°ë¥¼ ì§ê´€ì ì¸ ê·¸ë˜í”„ë¡œ ì œê³µí•©ë‹ˆë‹¤.<br><span style='color:#888;'>Visualize forecast results and up-to-date data with intuitive charts.</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì¸¡ ê²°ê³¼ -->
        <div class="card" id="resultCard" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">ì˜ˆì¸¡ ê²°ê³¼</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>ì˜ˆì¸¡ê°’ ë° ê³µê¸‰ ì¶”ì²œ</h6>
                        <table class="table">
                            <tr>
                                <td>ì˜ˆì¸¡ ìµœëŒ€ì „ë ¥</td>
                                <td id="prediction">-</td>
                            </tr>
                            <tr>
                                <td>ê³µê¸‰ ì¶”ì²œëŸ‰</td>
                                <td id="supplyRecommendation">-</td>
                            </tr>
                            <tr id="actualRow" style="display: none;">
                                <td>ì‹¤ì œ ì „ë ¥ ì°¨ë¶„</td>
                                <td id="actualValue">-</td>
                            </tr>
                            <tr id="errorRow" style="display: none;">
                                <td>ì˜¤ì°¨</td>
                                <td id="error">-</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>ëª¨ë¸ ì„±ëŠ¥ ì§€í‘œ</h6>
                        <table class="table">
                            <tr>
                                <td>MAE</td>
                                <td id="mae">-</td>
                            </tr>
                            <tr>
                                <td>RMSE</td>
                                <td id="rmse">-</td>
                            </tr>
                            <tr>
                                <td>MAPE</td>
                                <td id="mape">-</td>
                            </tr>
                            <tr>
                                <td>RÂ²</td>
                                <td id="r2">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- íŠ¹ì„± ì¤‘ìš”ë„ -->
        <div class="card" id="featureImportanceCard" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">íŠ¹ì„± ì¤‘ìš”ë„</h5>
                <div class="chart-container">
                    <canvas id="featureImportanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lineChart = null;
        let pieChart = null;
        let featureImportanceChart = null;

        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/dt/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    displayResults(data);
                } else {
                    alert('ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        function displayResults(data) {
            // ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('featureImportanceCard').style.display = 'block';

            // ë„ë„›í˜• íŒŒì´ì°¨íŠ¸ ì¹´ë“œë¥¼ ë§¨ ì•„ë˜ë¡œ ì´ë™
            var doughnutSection = document.querySelector('.doughnut-section');
            var container = document.querySelector('.container');
            if (doughnutSection && container) {
                container.appendChild(doughnutSection);
            }

            // ì˜ˆì¸¡ê°’ í‘œì‹œ
            document.getElementById('prediction').textContent = data.prediction.toFixed(2) + ' MW';
            document.getElementById('supplyRecommendation').textContent = data.supply_recommendation.toFixed(2) + ' MW';

            // ì‹¤ì œê°’ ë° ì˜¤ì°¨ í‘œì‹œ
            const actualRow = document.getElementById('actualRow');
            const errorRow = document.getElementById('errorRow');
            if (data.actual_value !== null) {
                actualRow.style.display = '';
                document.getElementById('actualValue').textContent = data.actual_value.toFixed(2) + ' MW';
                errorRow.style.display = '';
                document.getElementById('error').textContent = 
                    `${data.error_abs.toFixed(2)} MW (${data.error_pct.toFixed(2)}%)`;
            } else {
                actualRow.style.display = 'none';
                errorRow.style.display = 'none';
            }

            // ëª¨ë¸ ì„±ëŠ¥ ì§€í‘œ í‘œì‹œ
            document.getElementById('mae').textContent = data.model_metrics.mae?.toFixed(2) || '-';
            document.getElementById('rmse').textContent = data.model_metrics.rmse?.toFixed(2) || '-';
            document.getElementById('mape').textContent = data.model_metrics.mape?.toFixed(2) + '%' || '-';
            document.getElementById('r2').textContent = data.model_metrics.r2?.toFixed(4) || '-';

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateCharts(data);
        }

        function updateCharts(data) {
            // ë¼ì¸ ì°¨íŠ¸
            if (lineChart) lineChart.destroy();
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: data.line_labels,
                    datasets: [{
                        label: 'ì „ë ¥ ì°¨ë¶„(MW)',
                        data: data.line_values,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // íŒŒì´ ì°¨íŠ¸
            if (pieChart) pieChart.destroy();
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['ê³µê¸‰ ì¶”ì²œëŸ‰', 'ì˜ˆì¸¡ ì „ë ¥ ì°¨ë¶„'],
                    datasets: [{
                        data: data.pie_values,
                        backgroundColor: ['#64a8ff', '#ffe066']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // íŠ¹ì„± ì¤‘ìš”ë„ ì°¨íŠ¸
            if (featureImportanceChart) featureImportanceChart.destroy();
            const featureCtx = document.getElementById('featureImportanceChart').getContext('2d');
            featureImportanceChart = new Chart(featureCtx, {
                type: 'bar',
                data: {
                    labels: data.feature_importance.labels,
                    datasets: [{
                        label: 'íŠ¹ì„± ì¤‘ìš”ë„',
                        data: data.feature_importance.values,
                        backgroundColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        flatpickr.localize(flatpickr.l10ns.ko);
        flatpickr("#date", {
            dateFormat: "Y-m-d",
            locale: "ko",
            allowInput: true,
            defaultDate: new Date(),
            disableMobile: true,
            minDate: "2000-01-01",
            maxDate: "2100-12-31",
            static: true,
            monthSelectorType: "static"
        });

        // ë„ë„›í˜• íŒŒì´ì°¨íŠ¸ ìƒì„± ì½”ë“œ (í˜ì´ì§€ í•˜ë‹¨ì— ì¶”ê°€)
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('doughnutChartOuter') && document.getElementById('doughnutChartInner')) {
                const labels = ['01', '02', '03', '04'];
                const ctxOuter = document.getElementById('doughnutChartOuter').getContext('2d');
                new Chart(ctxOuter, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: [25, 25, 25, 25],
                            backgroundColor: [
                                '#a5b4fc', '#c4b5fd', '#6366f1', '#818cf8'
                            ],
                            borderWidth: 0,
                            hoverOffset: 8,
                            cutout: '30%',
                            rotation: -0.5 * Math.PI
                        }]
                    },
                    options: {
                        layout: { padding: 10 },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        animation: { animateRotate: true, animateScale: true },
                        responsive: false,
                    }
                });
                // Inner doughnut (thicker ring, êµ¬ë© ë” ì‘ê²Œ)
                const ctxInner = document.getElementById('doughnutChartInner').getContext('2d');
                new Chart(ctxInner, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: [25, 25, 25, 25],
                            backgroundColor: [
                                '#dbeafe', '#ede9fe', '#a5b4fc', '#c7d2fe'
                            ],
                            borderWidth: 0,
                            hoverOffset: 0,
                            cutout: '55%',
                            rotation: -0.5 * Math.PI
                        }]
                    },
                    options: {
                        layout: { padding: 10 },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        animation: { animateRotate: true, animateScale: true },
                        responsive: false,
                    }
                });
            }
        });
    </script>
</body>
</html> 